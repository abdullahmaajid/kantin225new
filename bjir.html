<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Summary</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>

<body>
    <div class="container mt-4">
        <h1 class="text-center">Order Summary</h1>

        <button class="btn btn-success mb-4" onclick="exportToExcel()">Export to Excel</button>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Customer Name</th>
                    <th>Date</th>
                    <th>Items</th>
                    <th>Total Price</th>
                    <th>Payment Method</th>
                    <th>Amount Paid</th>
                    <th>Change</th>
                    <th>Transfer Proof</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="orderTableBody">
                <!-- Order rows will be inserted here dynamically -->
            </tbody>
        </table>
    </div>

    <!-- Include libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const orders = [
            {
                customerName: "John Doe",
                date: "2024-10-01",
                items: [
                    { name: "Item 1", qty: 2 },
                    { name: "Item 2", qty: 1 }
                ],
                totalPrice: 300000,
                paymentMethod: "bank transfer",
                amountPaid: 300000,
                transferProof: "https://example.com/path/to/image.jpg"
            }
        ];

        if (!localStorage.getItem("orders")) {
            localStorage.setItem("orders", JSON.stringify(orders));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const orderTableBody = document.getElementById("orderTableBody");

            const populateOrderTable = () => {
                const orders = JSON.parse(localStorage.getItem("orders")) || [];
                orderTableBody.innerHTML = ''; // Clear the table before populating
                orders.forEach((order, index) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${order.customerName}</td>
                        <td>${order.date}</td>
                        <td>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Quantity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${order.items.map(item => `
                                        <tr>
                                            <td>${item.name}</td>
                                            <td>${item.qty}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </td>
                        <td>Rp ${order.totalPrice.toLocaleString()}</td>
                        <td>${order.paymentMethod}</td>
                        <td>${order.paymentMethod === 'cash' ? order.amountPaid : 'N/A'}</td>
                        <td>${order.paymentMethod === 'cash' ? (order.amountPaid - order.totalPrice).toLocaleString() : 'N/A'}</td>
                        <td>
                            ${order.transferProof ? `<a href="${order.transferProof}" target="_blank"><img src="${order.transferProof}" alt="Transfer Proof" style="width: 100px;" /></a>` : 'N/A'}
                        </td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="showEditForm(${index})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="removeOrder(${index})">Remove</button>
                            <button class="btn btn-primary btn-sm mt-2" onclick="exportToPDF(${index})">Export PDF</button>
                        </td>
                    `;
                    orderTableBody.appendChild(row);
                });
            };

            // Function to show SweetAlert form for editing
            window.showEditForm = (index) => {
              const orders = JSON.parse(localStorage.getItem("orders")) || [];
              const order = orders[index];
          
              // Create the edit form
              const html = `
                  <form id="editForm">
                      <div class="mb-3">
                          <label for="customerName" class="form-label">Customer Name</label>
                          <input type="text" class="form-control" id="customerName" value="${order.customerName}">
                      </div>
                      <div class="mb-3">
                          <label for="date" class="form-label">Date (YYYY-MM-DD)</label>
                          <input type="date" class="form-control" id="date" value="${order.date}">
                      </div>
                      <div class="mb-3">
                          <label for="totalPrice" class="form-label">Total Price</label>
                          <input type="number" class="form-control" id="totalPrice" value="${order.totalPrice}">
                      </div>
                      <div class="mb-3">
                          <label for="paymentMethod" class="form-label">Payment Method</label>
                          <input type="text" class="form-control" id="paymentMethod" value="${order.paymentMethod}">
                      </div>
                      <div class="mb-3">
                          <label for="amountPaid" class="form-label">Amount Paid</label>
                          <input type="number" class="form-control" id="amountPaid" value="${order.amountPaid}">
                      </div>
                      <div class="mb-3">
                          <label for="transferProof" class="form-label">Transfer Proof URL</label>
                          <input type="text" class="form-control" id="transferProof" value="${order.transferProof}">
                      </div>
                  </form>
              `;
          
              Swal.fire({
                  title: 'Edit Order',
                  html: html,
                  focusConfirm: false,
                  preConfirm: () => {
                      // Retrieve values from the form
                      const updatedOrder = {
                          customerName: document.getElementById("customerName").value.trim(),
                          date: document.getElementById("date").value,
                          totalPrice: Number(document.getElementById("totalPrice").value),
                          paymentMethod: document.getElementById("paymentMethod").value.trim(),
                          amountPaid: Number(document.getElementById("amountPaid").value),
                          transferProof: document.getElementById("transferProof").value.trim()
                      };
          
                      // Validate fields
                      if (!updatedOrder.customerName || !updatedOrder.date || !updatedOrder.totalPrice || !updatedOrder.paymentMethod || !updatedOrder.amountPaid) {
                          Swal.showValidationMessage('Please fill in all fields');
                          return false; // Prevent closing the alert
                      }
          
                      // Update the orders in localStorage
                      orders[index] = updatedOrder;
                      localStorage.setItem("orders", JSON.stringify(orders));
                      populateOrderTable(); // Refresh the order table
                  }
              });
          };
          

            // Remove function
            window.removeOrder = (index) => {
                const orders = JSON.parse(localStorage.getItem("orders")) || [];
                orders.splice(index, 1);
                localStorage.setItem("orders", JSON.stringify(orders));
                populateOrderTable();
            };

            // Function to export all orders to Excel
            window.exportToExcel = () => {
                const orders = JSON.parse(localStorage.getItem("orders")) || [];
                const worksheetData = orders.map((order, index) => {
                    const itemNames = order.items.map(item => item.name).join(", ");
                    const itemQtys = order.items.map(item => item.qty).join(", ");
                    return [
                        index + 1,
                        order.customerName,
                        order.date,
                        `${itemNames} (${itemQtys})`,
                        `Rp ${order.totalPrice.toLocaleString()}`,
                        order.paymentMethod,
                        order.amountPaid,
                        order.paymentMethod === 'cash' ? (order.amountPaid - order.totalPrice).toLocaleString() : 'N/A',
                        order.transferProof
                    ];
                });

                const worksheet = XLSX.utils.aoa_to_sheet([
                    ["No", "Customer Name", "Date", "Items", "Total Price", "Payment Method", "Amount Paid", "Change", "Transfer Proof"],
                    ...worksheetData
                ]);

                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Orders");
                XLSX.writeFile(workbook, "orders_summary.xlsx");
            };

            // Function to export individual order to PDF with a better design
            window.exportToPDF = (index) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const orders = JSON.parse(localStorage.getItem("orders")) || [];
                const order = orders[index];

                // Adding a title and improving the layout
                doc.setFontSize(16);
                doc.text(`Order Summary #${index + 1}`, 105, 20, null, null, "center");

                doc.setFontSize(12);
                doc.text(`Customer Name: ${order.customerName}`, 20, 40);
                doc.text(`Date: ${order.date}`, 20, 50);
                doc.text(`Total Price: Rp ${order.totalPrice.toLocaleString()}`, 20, 60);
                doc.text(`Payment Method: ${order.paymentMethod}`, 20, 70);

                // Adding items in the order
                let yPosition = 80;
                order.items.forEach((item, idx) => {
                    doc.text(`Item ${idx + 1}: ${item.name} - Qty: ${item.qty}`, 20, yPosition);
                    yPosition += 10;
                });

                doc.text(`Amount Paid: Rp ${order.amountPaid}`, 20, yPosition + 10);
                doc.text(`Change: ${order.paymentMethod === 'cash' ? (order.amountPaid - order.totalPrice).toLocaleString() : 'N/A'}`, 20, yPosition + 20);

                // Add transfer proof if available
                if (order.transferProof) {
                    doc.text(`Transfer Proof:`, 20, yPosition + 30);
                    doc.addImage(order.transferProof, "JPEG", 20, yPosition + 40, 50, 50); // Example position and size
                }

                doc.save(`order_${index + 1}.pdf`);
            };

            populateOrderTable();
        });
    </script>
</body>

</html>
